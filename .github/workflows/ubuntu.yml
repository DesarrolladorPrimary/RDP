name: Ubuntu-Desktop-noVNC

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Instalar dependencias
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl docker.io

      - name: Crear usuario de escritorio
        run: |
          PASS=$(openssl rand -base64 12)
          echo "DESKTOP_USER=user" >> $GITHUB_ENV
          echo "DESKTOP_PASS=$PASS" >> $GITHUB_ENV

      - name: Lanzar contenedor LXDE + noVNC
        run: |
          docker run -d \
            -p 8080:80 \
            -e USER=$DESKTOP_USER \
            -e PASSWORD=$DESKTOP_PASS \
            dorowu/ubuntu-desktop-lxde-vnc

      - name: Instalar Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-ubuntunovnc-$GITHUB_RUN_ID

      - name: Mostrar datos de acceso
        run: |
          echo "============================"
          echo " üåê Desktop noVNC disponible"
          echo " URL: http://$(tailscale ip -4):8080/vnc.html"
          echo " Usuario: $DESKTOP_USER"
          echo " Contrase√±a: $DESKTOP_PASS"
          echo "============================"

      - name: Mantener sesi√≥n
        run: |
          while true; do
            echo "[$(date)] ‚úÖ Desktop sigue activo"
            sleep 300
          done
