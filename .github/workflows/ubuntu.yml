name: Ubuntu-Desktop-noVNC

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Activar Docker ya incluido en el runner
        run: |
          sudo systemctl start docker
          sudo usermod -aG docker $USER
          docker --version

      - name: Crear usuario de escritorio
        run: |
          PASS=$(openssl rand -base64 12)
          echo "DESKTOP_USER=user" >> $GITHUB_ENV
          echo "DESKTOP_PASS=$PASS" >> $GITHUB_ENV

      - name: Lanzar contenedor LXDE + noVNC
        run: |
          docker run -d \
            -p 8080:6080 \
            -e USER=$DESKTOP_USER \
            -e PASSWORD=$DESKTOP_PASS \
            dorowu/ubuntu-desktop-lxde-vnc

      - name: Instalar Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
                            --hostname=gh-ubuntunovnc-$GITHUB_RUN_ID

      - name: Mostrar datos de acceso
        run: |
          TSIP=$(tailscale ip -4)
          echo "============================"
          echo " üåê Escritorio noVNC disponible"
          echo " URL (IP):     http://$TSIP:8080/vnc.html"
          echo " URL (DNS ts): http://gh-ubuntunovnc-$GITHUB_RUN_ID.tailscale.net:8080/vnc.html"
          echo ""
          echo " Usuario: $DESKTOP_USER"
          echo " Contrase√±a: $DESKTOP_PASS"
          echo "============================"

      - name: Mantener contenedor activo
        run: |
          while true; do
            echo "[$(date)] ‚úÖ Desktop con Docker sigue activo"
            sleep 300
          done
